24区可視化　作業方針
・macでの作業。文字コードutf-8前提。Windowsは未検証。
・Rで大阪市オープンデータポータルにある24区のシェープファイルに、csvを組み合わせて可視化する
・シェープファイルのATTR2が区名なので、それをキーに、.shpファイルと.csvファイルを結合させる
・そのため、事前にcsvファイルは区名の項目名をATTR2にしておくこと。

#ライブラリ読込
library(dplyr)
library(sf)
library(readr)
library(RColorBrewer)

#作業ディレクトリ指定
setwd("~/Desktop/health")

#24区シェープファイル読込
shape <- st_read("24区画像.shp")

#csvファイル読込
population <- read_csv("H29-10-suikei.csv")

#シェープファイルとcsvファイルを区名のATTR2をキーとして結合
data <- inner_join(shape, population, by="ATTR2")

#macではplotで文字化けするので防止
par(family = "HiraKakuProN-W3")

#可視化
plot(data)

#ラベル名指定で可視化
plot(data["ATTR2"])

#geometryだけ描画
plot(st_geometry(data))

#シェープファイル固有の前から5つは可視化しない
plot(data %>% select(-(1:5)))

#区名を中心部に描画　(st_coorinatesで緯度経度をsf用に変換する必要あり）
text(st_coordinates(data %>% st_centroid), labels=data$ATTR2, cex=1)

#ポイント描画
points(st_coordinates(osaka %>% st_centroid), lwd=30, col="red")

#k-means法で離散化してカラーパレット作成
col_km <- data$総数 %>% classIntervals(.,n=8,style=“means”) %>% findColours(.,pal=brewer.pal(8,”Reds”))

#項目を選択して可視化
plot(data %>% select(総数), col=col_km)

#項目はカラムの数値で指示可能
plot(data %>% select(6))

#pdfファイル生成ループ (plotの直前でpar(family=~を唱えないと文字化けする)
#ファイル名はMac -> Windowsで文字化けするため英字推奨。拡張子もつけて。
for (i in 6:8){
+  quartz(type="pdf", file=sprintf("sibouritsuH25_%d.pdf", i))
+  par(family="HiraKakuProN-W3")
+  plot(data3 %>% select(i))
+  dev.off()
+ }

#凡例
library(stringr)
legend(“topleft”, legend=str_sub(gsub(“,”, “~”, names(attr(col_km, “table”))), start=2, end=-2), fill=attr(col_km, “palette”))

#read.shape
install.packages("spsurvey")
library(spsurvey)
shape <- read.shape("24区画像.shp")
plot(shape)
